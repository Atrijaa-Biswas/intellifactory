<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntelliFactory | Global Overview</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>ğŸ­ IntelliFactory - Command Center</h1>
    
    <nav>
        <button onclick="location.href='index.html'" style="background: var(--primary); color: white;">Overview</button>
        <button onclick="location.href='cnc.html'">CNC (Temp/Press)</button>
        <button onclick="location.href='power.html'">Power & Cost</button>
        <button onclick="location.href='sustainability.html'">Sustainability</button>
        <button onclick="location.href='intelligence.html'">Intelligence</button>
        <button onclick="location.href='analytics.html'">Shift Analytics</button>
    </nav>

    <div class="card" style="margin-bottom: 20px; text-align: center;">
        <h3>Data Controller</h3>
        <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
            <input type="number" id="inPower" placeholder="Power (kW)">
            <input type="number" id="inTemp" placeholder="Temp (Â°C)">
            <input type="number" id="inPressure" placeholder="Pressure (bar)">
            <button onclick="manualPush()" style="background: var(--success); color: white;">ğŸš€ Push Data</button>
        </div>
        <hr style="border: 1px solid #e2e8f0; margin: 15px 0;">
        <label style="font-weight: bold; cursor: pointer;">
            <input type="checkbox" id="chkAutoMode" onchange="handleAuto()"> âš™ï¸ Enable Auto Mode (Simulate Live Factory)
        </label>
    </div>

    <div class="grid">
        <div class="card">
            <h3>Machine Status</h3>
            <span id="globalStatus" class="status-badge status-idle">WAITING</span>
            <div id="alertBox" style="margin-top: 10px; color: var(--danger); font-weight: bold;"></div>
        </div>

        <div class="card">
            <h3>CNC Parameters <button onclick="location.href='cnc.html'" style="padding: 2px 8px; font-size: 0.7rem;">Details</button></h3>
            <p>ğŸŒ¡ï¸ Temp: <span id="idxTemp" style="font-weight: bold; font-size: 1.2rem;">--</span> Â°C</p>
            <p>ğŸ’¨ Press: <span id="idxPressure" style="font-weight: bold; font-size: 1.2rem;">--</span> bar</p>
        </div>

        <div class="card">
            <h3>Power Load <button onclick="location.href='power.html'" style="padding: 2px 8px; font-size: 0.7rem;">Details</button></h3>
            <p>âš¡ <span id="idxPower" style="font-weight: bold; font-size: 1.5rem;">--</span> kW</p>
        </div>

        <div class="card">
            <h3>System Health <button onclick="location.href='intelligence.html'" style="padding: 2px 8px; font-size: 0.7rem;">Details</button></h3>
            <p>ğŸ›¡ï¸ Score: <span id="idxHealth" style="font-weight: bold; font-size: 1.5rem;">--</span>%</p>
        </div>

        <div class="card">
            <h3>Carbon Rate <button onclick="location.href='sustainability.html'" style="padding: 2px 8px; font-size: 0.7rem;">Details</button></h3>
            <p>ğŸŒ <span id="idxCarbon" style="font-weight: bold; font-size: 1.5rem;">--</span> kg/h</p>
        </div>
    </div>

    <script type="module">
        import { subscribeToLive, pushData, toggleAutoMode } from './js/data-service.js';
        import { getMachineStatus, calculateFailureRisk, calculateCarbon } from './js/calculations.js';

        // 1. Manual Push
        window.manualPush = () => {
            pushData({
                power: parseFloat(document.getElementById('inPower').value) || 0,
                temp: parseFloat(document.getElementById('inTemp').value) || 0,
                pressure: parseFloat(document.getElementById('inPressure').value) || 0
            });
        };

        // 2. Auto Mode
        window.handleAuto = () => {
            toggleAutoMode(document.getElementById('chkAutoMode').checked);
        };

        // 3. Real-Time UI Updates
        subscribeToLive((data) => {
            if(!data) return;
            
            // Populate Basic Values
            document.getElementById('idxTemp').innerText = data.temp.toFixed(1);
            document.getElementById('idxPressure').innerText = data.pressure.toFixed(2);
            document.getElementById('idxPower').innerText = data.power.toFixed(2);
            
            // Populate Calculated Values
            const risk = calculateFailureRisk(data);
            const healthScore = 100 - risk; // Inverse of risk
            document.getElementById('idxHealth').innerText = healthScore.toFixed(0);
            document.getElementById('idxCarbon').innerText = calculateCarbon(data.power);

            // Update Status Badge
            const status = getMachineStatus(data);
            const statusEl = document.getElementById('globalStatus');
            statusEl.innerText = status;
            statusEl.className = `status-badge status-${status.toLowerCase()}`;

            // Alerts
            const alertBox = document.getElementById('alertBox');
            if (data.temp > 880) alertBox.innerText = `âš ï¸ ALERT: Overheating (${data.temp.toFixed(1)}Â°C)`;
            else if (data.pressure > 7.5) alertBox.innerText = `âš ï¸ ALERT: High Pressure`;
            else alertBox.innerText = "";
        });
    </script>
</body>
</html>