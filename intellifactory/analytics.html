<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntelliFactory | Shift Analytics</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <h1>ðŸ“… High-Resolution Shift Analytics</h1>
    
    <nav>
        <button onclick="location.href='index.html'">Overview</button>
        <button onclick="location.href='cnc.html'">CNC (Temp/Press)</button>
        <button onclick="location.href='power.html'">Power & Cost</button>
        <button onclick="location.href='sustainability.html'">Sustainability</button>
        <button onclick="location.href='intelligence.html'">Intelligence</button>
        <button onclick="location.href='analytics.html'" style="background: var(--primary); color: white;">Analytics</button>
    </nav>

    <div class="card" style="text-align: center; margin-bottom: 20px;">
        <h3>Data Window: Last 1 Hour (3,600 Samples)</h3>
        <p style="color: #64748b;">Processing high-frequency 1-second logs from Firebase.</p>
    </div>

    <div class="grid">
        <div class="card" style="text-align: center; border-left: 5px solid var(--primary);">
            <h3>Avg Efficiency</h3>
            <h1 style="font-size: 3.5rem;"><span id="avgEff">--</span>%</h1>
        </div>

        <div class="card" style="text-align: center; border-left: 5px solid var(--warning);">
            <h3>Avg Temperature</h3>
            <h1 style="font-size: 3.5rem;"><span id="avgTemp">--</span> Â°C</h1>
        </div>
        
        <div class="card" style="text-align: center; border-left: 5px solid #94a3b8;">
            <h3>Active Samples</h3>
            <h1 style="font-size: 3.5rem;"><span id="dataCount">0</span></h1>
        </div>
    </div>

    <script type="module">
        import { subscribeToHistory } from './js/data-service.js';
        import { calculateFailureRisk } from './js/calculations.js';

        // Pull the last 3,600 seconds (1 hour)
        subscribeToHistory((history) => {
            const count = history.length;
            document.getElementById('dataCount').innerText = count;

            if (count === 0) {
                document.getElementById('avgEff').innerText = "--";
                document.getElementById('avgTemp').innerText = "--";
                return;
            }

            let totalTemp = 0;
            let totalEff = 0;

            history.forEach(d => {
                totalTemp += d.temp || 0;
                totalEff += (100 - calculateFailureRisk(d)); 
            });

            document.getElementById('avgTemp').innerText = (totalTemp / count).toFixed(1);
            document.getElementById('avgEff').innerText = (totalEff / count).toFixed(1);
        }, 3600); 
    </script>
</body>
</html>